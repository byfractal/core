<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authentication Callback</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        text-align: center;
      }

      .container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        max-width: 500px;
        width: 100%;
      }

      h1 {
        color: #333;
        margin-bottom: 1rem;
      }

      p {
        color: #666;
        margin-bottom: 2rem;
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        color: #e74c3c;
        background-color: #fde8e8;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container" id="app">
      <h1>Authentication in Progress</h1>
      <p>Please wait while we complete the authentication process...</p>
      <div class="loader"></div>
    </div>

    <script>
      // Fonction pour extraire les paramètres de l'URL
      function getUrlParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const pairs = queryString.split("&");

        for (const pair of pairs) {
          const [key, value] = pair.split("=");
          params[decodeURIComponent(key)] = decodeURIComponent(value || "");
        }

        return params;
      }

      // Fonction pour afficher une erreur
      function showError(message) {
        const app = document.getElementById("app");
        app.innerHTML = `
        <h1>Authentication Error</h1>
        <div class="error">${message}</div>
        <p>Please close this window and try again.</p>
      `;
      }

      // Fonction pour afficher un succès
      function showSuccess() {
        const app = document.getElementById("app");
        app.innerHTML = `
        <h1>Authentication Successful</h1>
        <p>You have been successfully authenticated. You can close this window and return to the plugin.</p>
      `;
      }

      // Exécution du code principal
      (function main() {
        try {
          // Récupérer les paramètres de l'URL
          const params = getUrlParams();

          // Vérifier s'il y a une erreur
          if (params.error) {
            showError(`Error: ${params.error_description || params.error}`);
            return;
          }

          // Vérifier s'il y a un code d'autorisation
          if (!params.code) {
            showError("No authorization code received");
            return;
          }

          // Envoyer le code d'autorisation au plugin Figma via postMessage
          // La cible est la fenêtre parente (opener)
          if (window.opener) {
            window.opener.postMessage(
              {
                type: "AUTH_CALLBACK",
                url: window.location.href,
              },
              "*"
            );

            // Afficher un message de succès
            showSuccess();

            // Fermer automatiquement cette fenêtre après 3 secondes
            setTimeout(() => {
              window.close();
            }, 3000);
          } else {
            showError(
              "Unable to communicate with the plugin. Please close this window and try again."
            );
          }
        } catch (error) {
          showError(`An unexpected error occurred: ${error.message}`);
        }
      })();
    </script>
  </body>
</html>
